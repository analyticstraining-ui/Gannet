config.py — El archivo de configuracion

  Este archivo no hace nada por si solo. Solo define constantes que los demas archivos importan. Es como un "diccionario central" para que si algo cambia (una ruta, una moneda, etc.) solo lo cambies aqui.

  Que contiene:

  - BASE_DIR: Detecta automaticamente donde esta la carpeta del proyecto. Todos los paths se construyen a partir de aqui.
  - ENTITIES: Un diccionario con la config de cada entidad (SL y LLC). Cada una tiene:
    - company: "SL" o "LLC" — lo que se escribe en la columna A del Excel
    - label: Nombre bonito para los mensajes de consola
    - data_dir: Donde buscar los CSVs de esa entidad
    - output_dir: Donde guardar los archivos de esa entidad
  - TEMPLATE_PATH: Ruta a la plantilla Week 6.xlsx (Weekly Report).
  - TA_TEMPLATE_PATH: Ruta a la plantilla Reporte_TAs_template.xlsx (Reporte mensual TAs).
  - FALLBACK_FX: Tipos de cambio de emergencia. Si la API falla, usa estos valores. Incluye "GPB" porque en los datos de Corsario hay ese typo (deberia ser GBP).
  - MONTH_NAMES_ES: Mapa de numero de mes a nombre en espanol. Se usa para nombres de hojas, headers, y nombres de archivos.

  ---
  src/data_loader.py — Lee los CSVs de Corsario

  Es el primer paso del proceso. Lee los CSVs crudos y los prepara.

  Funciones:

  - _find_csv(data_dir, base_name): Funcion interna que busca un CSV flexible. Primero intenta el nombre exacto (reserva.csv). Si no lo encuentra, busca variantes (reserva (1).csv, reserva_backup.csv, etc.). Esto es porque Corsario a veces te descarga el archivo con nombres raros. No tienes que renombrarlo.
  - load_reserva(data_dir): Lee el CSV de reservas.
    a. Abre el CSV con encoding latin-1 (porque Corsario usa acentos)
    b. Filtra la columna cancelada dejando solo las que tienen 0 (no canceladas)
    c. Ordena por folio de A a Z
  - load_dreserva(data_dir): Lee el CSV de detalle de reservas. Solo lo lee, sin filtrar nada.
  - compute_rentabilidad(dreserva_df): Agrupa dreserva por folio y suma la comision. Detecta automaticamente si la columna se llama monto_comision o comision_monto.

  ---
  src/fx_rates.py — Tipos de cambio historicos y actuales

  Usa la API de Frankfurter (datos del BCE, gratuita, sin API key) para obtener tipos de cambio.

  Funciones principales:

  - get_latest_fx(): Obtiene la tasa mas reciente del BCE. Se usa para la lookup table del Weekly y para el Reporte TAs.
  - get_historical_fx(fecha): Obtiene la tasa del dia exacto de una fecha. Si es fin de semana/festivo, retrocede al ultimo dia laborable. Cada reserva usa la tasa de su fecha de creacion.
  - preload_fx_months(dates): Pre-descarga las tasas de todos los meses que aparecen en las fechas de reserva. Esto evita hacer una llamada API por cada reserva.
  - get_current_month_daily_rates(): Descarga las tasas de cada dia laborable del mes actual. Se usa para la hoja FX RATES.

  Cache interno:
  - _fx_cache: Diccionario {date: {moneda: {EUR, USD}}} con todas las tasas descargadas.
  - _downloaded_months: Set de (year, month) ya descargados para no repetir llamadas.
  - Si la API falla, usa FALLBACK_FX de config.py.

  Monedas soportadas: EUR, USD, GBP (y GPB como alias), CHF, JPY, MXN.

  ---
  src/validators.py — Detector de errores

  Funcion detect_errors(reserva_df, rentabilidad_df):

  Recorre cada reserva activa y busca cosas raras. Los errores se imprimen en consola y se escriben en la hoja ERRORES del Weekly Report.

  Checks que hace:
  - total < 0: Monto negativo — algo esta mal en Corsario
  - rent < 0: Comision negativa
  - rent/total > 50%: Rentabilidad sospechosamente alta — probablemente error de carga
  - total == 0 y rent != 0: No hay venta pero si comision
  - Moneda desconocida (fuera de EUR/USD/GBP/CHF/MXN/JPY)
  - fecha_inicio vacia
  - fecha_fin vacia

  ---
  src/weekly/data_sheet.py — Construye la hoja DATA

  Funcion build_data_rows(reserva_df, rentabilidad_df, company):

  Toma las reservas filtradas, les cruza la rentabilidad, y construye una fila por reserva. Usa tipos de cambio historicos: cada reserva se convierte con la tasa del dia de su fecha de creacion.

  Columnas (A-Z):
  - A: Compania ("SL" o "LLC")
  - B: folio
  - C: cerrada (0 o 1)
  - D: fecha (fecha de creacion)
  - E: fecha_inicio, F: fecha_fin
  - G: vendedor
  - H: Semana (numero de semana ISO)
  - I: usuarios_invitados
  - J: total_cliente (moneda original)
  - K: moneda (EUR, USD, MXN, etc.)
  - L: Total Venta EUR (J * FX historico)
  - M: Total Venta USD (J * FX historico)
  - N: Rentabilidad (moneda original)
  - O: Rentabilidad EUR (N * FX historico)
  - P: Rentabilidad USD (N * FX historico)
  - Q: % Rentabilidad (N / J)
  - R: Mes, S: Ano (de D)
  - T: Mes Inicio, U: Ano Inicio (de E)
  - V: Fecha 45 dias fin (F + 45 dias)
  - W: mes 45 dias fin (nombre en espanol)
  - X: Ano 45 dias fin
  - Z: Observaciones

  ---
  src/weekly/data_serv_sheet.py — Construye la hoja DATA SERV

  Funcion build_serv_rows(dreserva_df, reserva_df, company):

  Filtra dreserva para quedarse solo con folios activos. Construye valores estaticos por servicio. Las formulas XLOOKUP se escriben despues en excel_writer.py.

  Columnas estaticas: B (compania), C (folio), E (proveedor), F (descripcion), G (inicio_estancia), H (fin_estancia), I (tipo_servicio), K (moneda), L (subtotal), O (monto_comision).

  ---
  src/weekly/excel_writer.py — Escribe el Excel final del Weekly

  Funcion generate_weekly_excel(...):

  Paso 1: Copia templates/Week 6.xlsx -> output/Week_N_YYYY.xlsx

  Paso 2: Escribe hoja DATA
  - Limpia filas existentes (columnas A-AA), deja headers en fila 1
  - Escribe data_rows fila por fila
  - Formatea: fechas como MM-DD-YY, montos como enteros, porcentajes como 0.00%

  Paso 3: Escribe hoja DATA SERV
  - Limpia columnas A-V (preserva lookup tables en Y-BO)
  - Escribe valores estaticos
  - Escribe formulas XLOOKUP para cada fila:
    - A: Oficina = XLOOKUP(vendedor -> pais)
    - D: vendedor = XLOOKUP(folio -> vendedor) — tabla diferente SL vs LLC
    - J: tipo servicio = XLOOKUP(codigo -> nombre)
    - M, N: Subtotal EUR/USD = subtotal * XLOOKUP(moneda -> tasa)
    - P, Q: Comision EUR/USD
    - R: Nombre proveedor (tabla diferente SL vs LLC)
    - S: Pais proveedor
    - T: Semana, U: Ano, V: Rentabilidad

  Paso 4: Actualiza tipos de cambio en lookup table (AM-AO)

  Paso 5: Configura pivots para auto-refresh (refreshOnLoad + rango actualizado)

  ---
  src/weekly/diferencia.py — Calcula Diferencia % interanual

  Funcion write_diferencia_pct(wb, data_rows):

  En la hoja "Weekly SL y LLC", calcula la diferencia porcentual entre las ventas del ano actual vs el ano anterior, semana a semana. Escribe los resultados en columna 9 con formato 0%.

  Formula: (Ventas 2026 USD - Ventas 2025 USD) / Ventas 2025 USD

  ---
  src/weekly/fx_sheet.py — Hoja FX RATES

  Funcion write_fx_sheet(wb):

  Crea la hoja "FX RATES" en el Weekly Report con tasas diarias del BCE del mes actual. 5 monedas (USD, GBP, CHF, JPY, MXN) con conversiones a EUR y USD.

  ---
  src/weekly/errores_sheet.py — Hoja ERRORES

  Funcion write_errores_sheet(wb, errors):

  Crea la hoja "ERRORES" con los errores detectados por validators.py. Columnas: Compania, Folio, Error, Vendedor, Fecha. Header rojo, auto-filter habilitado.

  ---
  src/bookings/booking_window.py — Matriz Booking Window

  build_booking_matrix(data_rows):
  Crea diccionario {semana_de_venta: {mes_de_salida: total_USD}}. Separa 2026 (keys 1-12) y 2027 (keys 14-25).

  write_booking_to_excel(wb, matrix):
  Escribe la matriz dentro de la hoja "Booking Window 2026" del Weekly Report. Cada semana ocupa 2 filas: montos USD y porcentajes.

  ---
  src/bookings/export_bookings.py — Export de Bookings

  Funcion export_bookings_xlsx(data_rows, output_path, company):

  Crea un Excel independiente con las reservas de una entidad. 25 columnas incluyendo todas las de DATA. Se genera para SL, LLC, y ALL (combinado).

  ---
  src/dashboard/dashboard.py — Dashboard con graficos

  Funcion generate_dashboard(data_rows, serv_rows, fx, output_path):

  Genera un Excel con 10 hojas de analisis, cada una con tablas formateadas y graficos:

  1. Rendimiento Vendedor: Top 15 vendedores por venta, rentabilidad y ticket medio
  2. Evolucion Semanal: Ventas semanales 2026 vs 2025 con variacion %
  3. Distribucion Rentabilidad: Distribucion de rentabilidad por rangos (0-5%, 5-10%, etc.)
  4. Booking Window: Ventas por ventana de anticipacion (lead time)
  5. Estacionalidad: Ventas por mes de inicio del viaje
  6. Mix Monedas: Distribucion de ventas por moneda (grafico de pastel)
  7. Rentabilidad por Servicio: Rentabilidad por tipo (HTL, VLO, PKT, TRF, HPS, ATR)
  8. Concentracion Ventas: Top 20 ventas con analisis Pareto
  9. LLC vs SL: Comparacion entre entidades
  10. Tasa Cierre: Porcentaje de cierre por vendedor

  Todas las hojas incluyen formato profesional con colores, bordes y graficos (barras, lineas, pastel, combo).

  ---
  src/individual/reports.py — Reportes individuales por TA

  Funcion generate_individual_reports(data_rows, output_dir, year, month):

  Genera un Excel por cada Travel Advisor con sus datos del mes. Crea directorios por TA.

  Cada Excel tiene 2 hojas:
  - Reporte: 2 tablas — ventas por mes de salida y ventas por mes calendario con rentabilidad
  - DATA: Datos completos del TA (20 columnas)

  Output: output/Reportes_Individuales_Mes_Ano/NombreTA/NombreTA_Mes_Ano.xlsx

  ---
  src/ta_monthly/report.py — Reporte Mensual Consolidado TAs

  Este es el modulo mas complejo. Genera el reporte mensual de todos los TAs.

  Funcion principal: generate_ta_monthly_report(data_rows, output_dir, fx, year, month)

  Flujo:
  1. Copia template Reporte_TAs_template.xlsx
  2. Limpia hojas innecesarias del template (_cleanup_sheets)
  3. Enriquece datos con plantilla corsario: agrega oficina, linea de negocio, comisionamiento, fecha incorporacion (enrich_data_rows)
  4. Escribe hoja DATA NEW con datos enriquecidos + tabla FX + plantilla corsario
  5. Crea hoja FX RATES con tasas diarias del BCE
  6. Prepara hojas de reportes: limpia cache, ajusta layout de pivots, escribe labels y formulas XLOOKUP
  7. Actualiza filtros de 5 pivot tables (_update_pivot_filters):
     - TablaDinamica1: Venta del mes (Mes = target, Ano = target)
     - TablaDinamica2: Venta YTD (Mes = 1..target, Ano = target)
     - TablaDinamica3: Venta por mes de inicio (Ano Inicio = target)
     - TablaDinamica4: Venta por mes (todos los meses, Ano = target)
     - Ventas LN: YTD agrupado por Oficina > LN > Vendedor
  8. Force refresh para Excel Windows (_force_pivot_refresh):
     a. fullCalcOnLoad=True: recalcula todas las formulas al abrir
     b. refreshOnLoad=True: pide a Excel que refresque cada pivot cache
     c. recordCount=0: provoca un mismatch que fuerza rebuild del cache
     d. Rango fuente actualizado: garantiza que cubra todos los datos nuevos
     e. Registros cacheados vaciados: elimina datos antiguos del XML
  9. Crea hoja SUMMARY con datos pre-calculados en Python (_write_summary_sheet):
     - Report 1: Venta del mes actual (Oficina > LN > Vendedor)
     - Report 2: Venta YTD (Oficina > LN > Vendedor)
     - Report 3: Venta por mes de inicio (Vendedor x Mes)
     - Report 4: Venta por mes calendario (Vendedor x Mes, con Fecha Incorporacion)
  10. Ordena hojas: Reportes TA > Ventas LN > SUMMARY > DATA NEW > FX RATES
  11. Guarda

  Hojas del output:
  - Reportes TA {Mes}: 4 pivot tables + labels + formulas XLOOKUP
  - Ventas por Linea de Negocio: Pivot YTD con jerarquia Oficina > LN > Vendedor
  - SUMMARY: Datos estaticos pre-calculados (funciona en Apple Numbers, Google Sheets, cualquier app)
  - DATA NEW: 30 columnas de datos enriquecidos + tabla plantilla corsario (AI-AM) + tabla FX (AO-AQ)
  - FX RATES: Tasas diarias del mes actual del BCE

  Compatibilidad multiplataforma:
  - Excel Mac: pivots se refrescan automaticamente al abrir
  - Excel Windows: los 5 mecanismos de force refresh garantizan que los pivots se recarguen
  - Apple Numbers: pivots no funcionan (limitacion de Numbers), pero la hoja SUMMARY muestra todos los datos correctamente
  - Google Sheets: pivots se refrescan, SUMMARY tambien visible

  Datos de la plantilla corsario (plantilla_corsario.csv):
  Cada TA tiene: usuario_corsario, linea_negocio, comisionamiento (%), pais_trabajo, fecha_inicio.
  Se usa para enriquecer DATA NEW con columnas Y-AD (Oficina, LN, Comision, Renta after COM, Fecha Inc).

  ---
  main.py — El orquestador

  Es lo unico que ejecutas. Coordina todo el flujo.

  Argumentos:
  - --weekly, --bookings, --dashboard, --individual, --ta-monthly: Flags de reporte (sin flags = todos)
  - --week N: Numero de semana (default: semana actual)
  - --entity espana|mexico|all: Que entidad procesar (default: all)
  - --report-month N: Mes para reportes individuales (default: mes anterior)

  Step 1: Tipos de cambio — llama get_latest_fx() una vez.

  Step 2: Carga datos por entidad — para cada entidad (SL, LLC):
  1. Carga reserva.csv y dreserva.csv
  2. Pre-descarga tasas historicas de FX
  3. Calcula rentabilidad
  4. Construye filas DATA y DATA SERV
  5. Genera Bookings por entidad
  6. Valida errores
  7. Acumula todo para los reportes combinados

  Step 3: Genera reportes seleccionados:
  - --weekly: Weekly Report (copia template, escribe DATA/DATA SERV, booking window, diferencia %, FX, errores, pivots)
  - --bookings: Bookings combinado (SL + LLC en un solo archivo)
  - --dashboard: Dashboard con 10 hojas de analisis y graficos
  - --individual: Un Excel por TA del mes (default: mes anterior)
  - --ta-monthly: Reporte mensual consolidado (pivots + SUMMARY + force refresh)

  Step 4: Resumen en consola con totales por entidad.
